<div class="book-edit-container">
  <mat-card>
    <mat-card-header>
      @if(isEdition){
        <mat-card-title>Modifier le livre</mat-card-title>
      } @else {
        <mat-card-title>Créer un livre</mat-card-title>
      }
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="bookForm" (ngSubmit)="onSubmit()">
        <div class="form-layout">
          <!-- Colonne gauche : couverture -->
          <div class="cover-section">
            <img [src]="currentCoverUrl"
                 alt="Couverture du livre"
                 class="book-cover">

            <!--<div class="cover-upload">
              <button type="button" mat-stroked-button (click)="fileInput.click()">
                <mat-icon>photo_camera</mat-icon>
                Changer la couverture
              </button>
              <input #fileInput type="file"
                     accept="image/*"
                     (change)="onFileSelected($event)"
                     style="display: none">
            </div>-->
          </div>

          <!-- Colonne droite : formulaire -->
          <div class="form-section">

            @if(isLoading){
              <mat-progress-bar
                mode="indeterminate">
              </mat-progress-bar>
            }


            <!--
                        <div class="api-selection">
                          <mat-checkbox formControlName="useExternalApi" (change)="onApiSelectionChange($event)">
                            Récupérer les informations depuis une API externe
                          </mat-checkbox>

                          @if(bookForm.controls.useExternalApi.value){
                            <div class="api-info">
                              <p>
                                <mat-icon>info</mat-icon>
                                Les données seront récupérées depuis Google Books
                              </p>
                            </div>
                          }
                        </div>
            -->

            <!--<mat-divider></mat-divider>-->

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>ISBN</mat-label>
              <input matInput formControlName="isbn" required (change)="onChangeISBN()">
             <!-- <input matInput formControlName="isbn" required />-->
              <mat-hint>Après saisie de l'ISBN, l'application utilise une API externe (Google Book API) pour récupérer la couverture</mat-hint>
              @if(bookForm.controls.isbn.hasError('required')){
                <mat-error>
                  L'ISBN est requis
                </mat-error>
              }
              @if(bookForm.controls.isbn.hasError('pattern')){
                <mat-error>
                  Format ISBN invalide
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Titre</mat-label>
              <input matInput formControlName="title" required [readonly]="bookForm.controls.useExternalApi.value">
              @if(bookForm.get('title')?.hasError('required')){
                <mat-error>
                  Le titre est requis
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Auteur</mat-label>
              <input matInput formControlName="author" required [readonly]="bookForm.controls.useExternalApi.value">
              @if(bookForm.controls.author.hasError('required')){
                <mat-error>
                  L'auteur est requis
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Catégorie</mat-label>
              <mat-select (selectionChange)="onCategoryChange()" formControlName="category">
                @for(category of BOOK_GENRES; track category){
                  <mat-option [value]="category.category">
                    {{category.category}}
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Genre</mat-label>
              <mat-select formControlName="kind" required>
                @for(kind of genres; track kind){
                  <mat-option [value]="kind">
                    {{kind}}
                  </mat-option>
                }
              </mat-select>
              @if(bookForm.controls.kind.hasError('required')){
                <mat-error>
                  Le genre du livre est requis
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Année de publication</mat-label>
              <input matInput formControlName="yearPublish" type="number" required [readonly]="bookForm.controls.useExternalApi.value">
              @if(bookForm.controls.yearPublish.hasError('required')){
                <mat-error>
                  L'année de publication est requise
                </mat-error>
              }

              @if(bookForm.controls.yearPublish.hasError('min') || bookForm.controls.yearPublish.hasError('max')){
                <mat-error>
                  L'année doit être valide
                </mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description"
                        rows="5" required [readonly]="bookForm.controls.useExternalApi.value"></textarea>
              @if(bookForm.controls.description.hasError('required')){
                <mat-error>
                  La description est requise
                </mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <!-- Boutons d'action -->
        <div class="action-buttons">
          <button type="button" mat-stroked-button (click)="onCancel()">
            <mat-icon>close</mat-icon>
            Annuler
          </button>
          <button type="submit" mat-raised-button color="primary"
                  [disabled]="bookForm.invalid">
            <mat-icon>save</mat-icon>
            Enregistrer
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
